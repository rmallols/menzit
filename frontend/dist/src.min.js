/* Minified js files! 2014-08-24 */
"use strict";var menzit=angular.module("menzit",["portal","app","ui.router"]);less={env:"development",logLevel:0};var app=angular.module("app",["ngAnimate"]);app.config(function($locationProvider,$stateProvider,$urlRouterProvider){$locationProvider.html5Mode(!0),$stateProvider.state("app",{templateUrl:"/src/app/app.html",controller:"AppCtrl",resolve:{session:["http","session",function(http,session){return session.getSession()}]}}).state("app.categories",{url:"/categories",templateUrl:"/src/app/categories/categories.html",controller:"CategoriesCtrl"}).state("app.test",{url:"/categories/:categoryId/test",templateUrl:"/src/app/test/test.html",controller:"TestCtrl"}).state("app.admin",{url:"/admin",templateUrl:"/src/app/admin/admin.html",controller:"AdminCtrl",data:{groupId:"admin"}}),$urlRouterProvider.otherwise("/")});var portal=angular.module("portal",["ui.router"]);portal.config(function($locationProvider,$stateProvider,$urlRouterProvider){$locationProvider.html5Mode(!0),$stateProvider.state("portal",{templateUrl:"/src/portal/portal.html",controller:"PortalCtrl"}).state("portal.home",{url:"/home",templateUrl:"/src/portal/home/home.html",controller:"HomeCtrl"}),$urlRouterProvider.otherwise("/")}),menzit.config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["loading",function(loading){return{request:function(config){return loading.start(),config},response:function(response){return loading.done(),response}}}])}]),menzit.service("http",["$http","$q",function($http,$q){function get(url){var deferred=$q.defer();return $http.get(url).then(function(response){deferred.resolve(response.data)}),deferred.promise}function post(url,data){var deferred=$q.defer();return $http.post(url,data).then(function(response){deferred.resolve(response.data)}),deferred.promise}function put(url,data){var deferred=$q.defer();return $http.put(url,data).then(function(response){deferred.resolve(response.data)}),deferred.promise}function remove(url){var deferred=$q.defer();return $http.delete(url).then(function(response){deferred.resolve(response.data)}),deferred.promise}return{get:get,post:post,put:put,"delete":remove}}]),menzit.service("loading",["$timeout",function($timeout){function start(){NProgress.inc()}function done(){$timeout(function(){NProgress.done()},1e3)}return{start:start,done:done}}]),menzit.service("pubSub",[function(){function publish(eventName,data){PubSub.publish(eventName,data)}function subscribe(eventName,subscribeFn){return PubSub.subscribe(eventName,subscribeFn)}function unsubscribe(subscribeFn){PubSub.unsubscribe(subscribeFn)}return{publish:publish,subscribe:subscribe,unsubscribe:unsubscribe}}]),menzit.service("session",["http",function(http){function login(userName,password){var credentials={userName:userName,password:password};return http.post("/rest/login",credentials)}function logout(){return http.post("/rest/logout")}function getSession(){return http.get("/rest/session/")}return{login:login,logout:logout,getSession:getSession}}]),menzit.controller("PortalCtrl",[function(){}]),portal.controller("HomeCtrl",[function(){}]),menzit.controller("AppCtrl",["$rootScope","$scope","$state",function($rootScope,$scope,$state){function setCurrentStateStyleClasses(currentState){stateName=currentState.name.replace(/\./g,"-"),stateGroupId=currentState.data?currentState.data.groupId.replace(/\./g,"-"):""}var stateName,stateGroupId;setCurrentStateStyleClasses($state.current),$rootScope.$on("$stateChangeSuccess",function(e,toState){setCurrentStateStyleClasses(toState)}),$scope.getRootStyleClasses=function(){var rootStyleClasses={};return rootStyleClasses.root=!0,rootStyleClasses[stateName]=!0,rootStyleClasses[stateGroupId]=!0,rootStyleClasses}}]),app.controller("AdminCtrl",["$scope","$state",function($scope,$state){$scope.menuActions=[{label:"General",icon:"settings-general-icon",uiSref:"app.admin.tenant",subGroupId:"tenant"},{label:"Tests",icon:"settings-tests-icon",uiSref:"app.admin.categories",subGroupId:"categories"},{label:"Users",icon:"settings-users-icon",uiSref:"app.admin.users",subGroupId:"users"}],$scope.isActiveAction=function(targetState){return{active:targetState===$state.current.data.subGroupId}}}]),app.controller("CategoriesAdminCtrl",["$scope","$state","http",function($scope,$state,http){function loadCategories(){http.get("/rest/categories").then(function(response){$scope.categories=response})}loadCategories(),$scope.add=function(){$state.go("app.admin.addCategory")},$scope.edit=function(category){$state.go("app.admin.editCategory",{categoryId:category._id})},$scope.viewTests=function(category){$state.go("app.admin.tests",{categoryId:category._id})},$scope.confirmDelete=function(category){$scope.categoryToBeDeleted=category},$scope.delete=function(){http.delete("/rest/categories/"+$scope.categoryToBeDeleted._id).then(function(){$scope.categoryToBeDeleted=null,loadCategories()})}}]),app.controller("CategoryAddAdminCtrl",["$scope","$state","http",function($scope,$state,http){$scope.title="Add category",$scope.category={tests:[]},$scope.submit=function(){http.post("/rest/categories/",$scope.category).then(function(){$state.go("app.admin.categories")})}}]),app.controller("CategoryEditAdminCtrl",["$scope","$state","http","category",function($scope,$state,http,category){$scope.title="Edit category",$scope.category=category,$scope.submit=function(){var categoryRestUrl="/rest/categories/"+$state.params.categoryId;http.put(categoryRestUrl,$scope.category).then(function(){$state.go("app.admin.categories")})}}]),app.config(function($stateProvider){$stateProvider.state("app.admin.categories",{url:"/categories",templateUrl:"/src/app/admin/categories/categoriesAdmin.html",controller:"CategoriesAdminCtrl",data:{subGroupId:"categories"}}).state("app.admin.addCategory",{url:"/categories/add",templateUrl:"/src/app/admin/categories/categoryAdmin.html",controller:"CategoryAddAdminCtrl",data:{subGroupId:"categories"}}).state("app.admin.editCategory",{url:"/categories/edit/:categoryId",templateUrl:"/src/app/admin/categories/categoryAdmin.html",controller:"CategoryEditAdminCtrl",resolve:{category:["$stateParams","http",function($stateParams,http){return http.get("/rest/categories/"+$stateParams.categoryId)}]},data:{subGroupId:"categories"}})}),app.controller("TestAddAdminCtrl",["$scope","$state","http",function($scope,$state,http){console.log("ALL THE TEST STUFF SHOULD BE RENAMED TO QUESTION"),$scope.title="Add test",$scope.correctOptionIndex=0,$scope.test={categoryId:$state.params.categoryId,answers:[{},{},{},{}]},$scope.submit=function(){angular.forEach($scope.test.answers,function(answer,$index){answer.isCorrect=$index===Number($scope.correctOptionIndex)}),http.post("/rest/tests/",$scope.test).then(function(){$state.go("app.admin.tests",{categoryId:$state.params.categoryId})})}}]),app.controller("TestEditAdminCtrl",["$scope","$state","http","test",function($scope,$state,http,test){$scope.title="Edit test",$scope.test=test,angular.forEach($scope.test.answers,function(answer,$index){answer.isCorrect&&($scope.correctOptionIndex=$index)}),$scope.submit=function(){var testRestUrl="/rest/tests/"+$state.params.testId;angular.forEach($scope.test.answers,function(answer,$index){answer.isCorrect=$index===Number($scope.correctOptionIndex)}),http.put(testRestUrl,$scope.test).then(function(){$state.go("app.admin.tests",{categoryId:$state.params.categoryId})})}}]),app.controller("TestsAdminCtrl",["$scope","$state","http","category",function($scope,$state,http,category){function loadTests(){var endpoint="/rest/tests?categoryId="+$state.params.categoryId;http.get(endpoint).then(function(tests){$scope.tests=tests})}loadTests(),$scope.category=category,$scope.add=function(){$state.go("app.admin.addTest",{categoryId:$state.params.categoryId})},$scope.edit=function(test){$state.go("app.admin.editTest",{testId:test._id,categoryId:$state.params.categoryId})},$scope.confirmDelete=function(test){$scope.testToBeDeleted=test},$scope.delete=function(){http.delete("/rest/tests/"+$scope.testToBeDeleted._id).then(function(){$scope.testToBeDeleted=null,loadTests()})}}]),app.config(function($stateProvider){$stateProvider.state("app.admin.tests",{url:"/categories/:categoryId/tests",templateUrl:"/src/app/admin/categories/tests/testsAdmin.html",controller:"TestsAdminCtrl",resolve:{category:["$stateParams","http",function($stateParams,http){return http.get("/rest/categories/"+$stateParams.categoryId)}]},data:{subGroupId:"categories"}}).state("app.admin.addTest",{url:"/categories/:categoryId/tests/add",templateUrl:"/src/app/admin/categories/tests/testAdmin.html",controller:"TestAddAdminCtrl",data:{subGroupId:"categories"}}).state("app.admin.editTest",{url:"/categories/:categoryId/tests/edit/:testId",templateUrl:"/src/app/admin/categories/tests/testAdmin.html",controller:"TestEditAdminCtrl",resolve:{test:["$stateParams","http",function($stateParams,http){return http.get("/rest/tests/"+$stateParams.testId)}]},data:{subGroupId:"categories"}})}),app.controller("TenantCtrl",["$rootScope","$scope","$state","http","session",function($rootScope,$scope,$state,http,session){function setupTenant(session){http.get("/rest/tenants/"+session.tenantId).then(function(tenant){$scope.tenant=tenant})}console.log("session, nunca deberia llegarse con un valor vacio a este punto",session),setupTenant(session),$rootScope.$on("authenticatedUser",function(e,session){setupTenant(session)}),$scope.cancel=function(){$state.go("app.categories")},$scope.save=function(){var data={name:$scope.tenant.name,logo:$scope.tenant.logo};http.put("/rest/tenants/"+session.tenantId,data).then(function(){console.log("YEA, GUARDADO")})}}]),app.config(function($stateProvider){$stateProvider.state("app.admin.tenant",{url:"/tenant",templateUrl:"/src/app/admin/tenant/tenant.html",controller:"TenantCtrl",data:{subGroupId:"tenant"}})}),app.controller("UserAddAdminCtrl",["$scope","$state","http",function($scope,$state,http){$scope.title="Add user",$scope.submit=function(){http.post("/rest/users/",$scope.user).then(function(){$state.go("app.admin.users")})}}]),app.controller("UserEditAdminCtrl",["$scope","$state","http",function($scope,$state,http){var userRestUrl="/rest/users/"+$state.params.userId;$scope.title="Edit user",http.get(userRestUrl).then(function(response){$scope.user=response}),$scope.submit=function(){http.put(userRestUrl,$scope.user).then(function(){$state.go("app.admin.users")})}}]),app.controller("UsersAdminCtrl",["$scope","$state","http",function($scope,$state,http){function loadUsers(){http.get("/rest/users").then(function(response){$scope.users=response})}loadUsers(),$scope.add=function(){$state.go("app.admin.addUser")},$scope.edit=function(user){$state.go("app.admin.editUser",{userId:user._id})},$scope.confirmDelete=function(user){$scope.userToBeDeleted=user},$scope.delete=function(){http.delete("/rest/users/"+$scope.userToBeDeleted._id).then(function(){$scope.userToBeDeleted=null,loadUsers()})}}]),app.config(function($stateProvider){$stateProvider.state("app.admin.users",{url:"/users",templateUrl:"/src/app/admin/users/usersAdmin.html",controller:"UsersAdminCtrl",data:{subGroupId:"users"}}).state("app.admin.addUser",{url:"/users/add",templateUrl:"/src/app/admin/users/userAdmin.html",controller:"UserAddAdminCtrl",data:{subGroupId:"users"}}).state("app.admin.editUser",{url:"/users/edit/:userId",templateUrl:"/src/app/admin/users/userAdmin.html",controller:"UserEditAdminCtrl",data:{subGroupId:"users"}})}),app.controller("CategoriesCtrl",["$scope","$state","http",function($scope,$state,http){http.get("/rest/categories").then(function(response){$scope.categories=response}),$scope.launchTest=function(category){$state.go("app.test",{categoryId:category._id})}}]),function(){app.directive("dialog",[function(){return{replace:!0,restrict:"A",transclude:!0,scope:{title:"@",mzIf:"="},templateUrl:"/src/app/common/dialog/dialog.html",link:function(scope){scope.hideDialog=function(){scope.mzIf=!1},angular.element(document).bind("keyup",function(e){27===e.keyCode&&(scope.hideDialog(),scope.$apply())})}}}]),app.directive("centered",[function(){return{restrict:"A",link:function(scope,element){var elementHeight=element.outerHeight(),elementWidth=element.outerWidth();scope.centerBox=function(){return{marginTop:-(elementHeight/2),marginLeft:-(elementWidth/2)}}}}}])}(),app.directive("title",[function(){return{link:function(scope,element,attrs){element.data("powertip",attrs.title),element.powerTip({})}}}]),app.directive("truncate",["$timeout",function($timeout){return{link:function(scope,element){$timeout(function(){element.dotdotdot({watch:"window"})})}}}]),app.directive("upload",[function(){return{replace:!0,restrict:"A",templateUrl:"/src/app/common/upload/upload.html",scope:{ngModel:"="},link:function(scope,element){function handleFileSelect(evt){var reader,file=evt.target.files[0];file.type.match("image.*")&&(reader=new FileReader,reader.onload=function(){return function(e){scope.ngModel=e.target.result,scope.$apply()}}(),reader.readAsDataURL(file))}scope.addImage=function(){inputElement.click()},scope.delete=function(){scope.ngModel=null,inputElement.val("")};var inputElement=angular.element('input[type="file"]',element);inputElement.bind("change",handleFileSelect)}}}]),function(){app.directive("menu",["$rootScope","$state","session",function($rootScope,$state,session){return{replace:!0,restrict:"A",templateUrl:"/src/app/menu/menu.html",link:function(scope){session.getSession().then(function(session){scope.session=session}),scope.showAdminOptions=function(){$state.go("app.admin.tenant")},scope.showLoginDialog=function(){scope.credentials={},scope.showLogin=!0},scope.login=function(){var userName=scope.credentials.userName,password=scope.credentials.password;session.login(userName,password).then(function(session){session?($rootScope.$emit("authenticatedUser",session),scope.session=session,scope.showLogin=!1):window.alert("LOGIN INCORRECTO")})},scope.logout=function(){session.logout().then(function(){scope.session=void 0,$state.go("app.categories")})},scope.isActiveAction=function(){var stateData=$state.current.data;return{active:stateData&&"admin"===stateData.groupId}}}}}])}(),function(){app.controller("TestDataCtrl",["$scope","$interval","pubSub",function($scope,$interval,pubSub){var scoreUpdatedSub,updateScoreIntervalFn;$scope.score=0,$scope.setProgressWidth=function(){return $scope.testData?{width:$scope.testData.runnedQuestions/$scope.testData.totalQuestions*100+"%"}:null},scoreUpdatedSub=pubSub.subscribe("scoreUpdated",function(msg,data){$scope.testData=data,$scope.$apply(),updateScoreIntervalFn=$interval(function(){$scope.score<$scope.testData.score?$scope.score+=1:$interval.cancel(updateScoreIntervalFn)},5)}),$scope.getCurrentQuestion=function(){return $scope.testData.runnedQuestions<$scope.testData.totalQuestions?$scope.testData.runnedQuestions+1:$scope.testData.runnedQuestions},$scope.$on("$destroy",function(){$interval.cancel(updateScoreIntervalFn),pubSub.unsubscribe(scoreUpdatedSub)})}])}(),app.controller("TestCtrl",["$scope","$timeout","pubSub",function($scope,$timeout,pubSub){function finishTest(){$timeout(function(){$scope.isTestInProgress=!1,$timeout(function(){$scope.isTestFinished=!0},1e3)},1500)}$scope.isTestInProgress=!0;var scoreUpdatedSub=pubSub.subscribe("scoreUpdated",function(msg,data){data.runnedQuestions===data.totalQuestions&&finishTest()});$scope.$on("$destroy",function(){pubSub.unsubscribe(scoreUpdatedSub)})}]),app.controller("QuestionsCtrl",["$scope","$timeout","$state","http","pubSub",function($scope,$timeout,$state,http,pubSub){function setCorrectAnswer(answer){$scope.isCorrectAnswer=!0,answer.validAssert=!0,setScore(),isLastQuestion()?$scope.isTestComplete=!0:$timeout(function(){$scope.getNextTest()},1e3)}function setIncorrectAnswer(answer){answer.invalidAssert=answer.invalidAssert?!1:!answer.isCorrect,failedAnswers<$scope.question.answers.length-1&&failedAnswers++}function setCurrentTest(){var questionId=getQuestionId();runnedQuestions.push(questionId),failedAnswers=0,$scope.question=availableQuestions[questionId]}function getQuestionId(){var proposedQuestionIndex;do proposedQuestionIndex=parseInt(Math.random()*availableQuestions.length);while(runnedQuestions.indexOf(proposedQuestionIndex)>=0);return proposedQuestionIndex}function isLastQuestion(){return runnedQuestions.length===availableQuestions.length}function setScore(){var maxQuestionScore=100;void 0===$scope.score?$scope.score=0:$scope.score+=maxQuestionScore-failedAnswers*Math.ceil(maxQuestionScore/$scope.question.answers.length),sendScoreEvent()}function sendScoreEvent(){pubSub.publish("scoreUpdated",{score:$scope.score,runnedQuestions:runnedQuestions.length,totalQuestions:availableQuestions.length})}var failedAnswers,availableQuestions=[],runnedQuestions=[];http.get("/rest/tests?categoryId="+$state.params.categoryId).then(function(questions){availableQuestions=questions,setScore(),setCurrentTest()}),$scope.answerCodes=["A","B","C","D"],$scope.setAnswer=function(answer){answer.isCorrect?setCorrectAnswer(answer):setIncorrectAnswer(answer)},$scope.getNextTest=function(){setCurrentTest(),$scope.isCorrectAnswer=!1},$scope.getLayoutStyleClass=function(){var columns=4===$scope.question.answers.length?2:$scope.question.answers.length;return"l-1-"+columns}}]),app.controller("ResultsCtrl",["$scope","$state","$timeout","$interval","$q","$stateParams","http","pubSub",function($scope,$state,$timeout,$interval,$q,$stateParams,http,pubSub){function finishTest(score){displayResult(score),saveScore(score).then(loadBestResults)}function loadBestResults(){http.get("/rest/scores?categoryId="+$state.params.categoryId).then(function(bestResults){$scope.bestResults=bestResults})}function displayResult(score){$timeout(function(){$scope.score=0,updateScoreIntervalFn=$interval(function(){$scope.score<score?$scope.score+=1:($interval.cancel(updateScoreIntervalFn),$timeout(function(){$scope.showBestResults=!0},3e3))},5)},3500)}function saveScore(score){var deferred=$q.defer();return http.post("/rest/scores/",{score:score,categoryId:$state.params.categoryId}).then(function(savedScore){currentResult=savedScore,deferred.resolve(savedScore)}),deferred.promise}var scoreUpdatedSub,updateScoreIntervalFn,currentResult;scoreUpdatedSub=pubSub.subscribe("scoreUpdated",function(msg,data){data.runnedQuestions===data.totalQuestions&&finishTest(data.score)}),$scope.$on("$destroy",function(){pubSub.unsubscribe(scoreUpdatedSub)}),$scope.isCurrentBestResult=function(bestResult){return bestResult._id===currentResult._id},$scope.repeatTest=function(){$state.transitionTo($state.current,$stateParams,{reload:!0,inherit:!1,notify:!0})},$scope.goToHome=function(){$state.go("app.categories")}}]);